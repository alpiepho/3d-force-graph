<head>
  <style>
    body {
      margin: 0;
    }
  </style>

  <script src="//unpkg.com/3d-force-graph"></script>
  <!--  <script src="../../dist/3d-force-graph.js"></script>-->

  <style>
    .node-label {
      font-size: 12px;
      padding: 1px 4px;
      border-radius: 4px;
      background-color: rgba(0, 0, 0, 0.5);
      user-select: none;
    }

    #racksmenu {
      z-index: 10;
    }

    .menuspace {
      display: inline;
    }




    /* .multipleSelection {
      display: inline-block;
      width: 100px;
      background-color: #BCC2C1;
    }

    .selectBox {
      position: relative;
    }

    .selectBox select {
      width: 100%;
    }

    .overSelect {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
    }

    .checkBoxes {
      display: none;
      border: 1px #8DF5E4 solid;
    }

    .checkBoxes label {
      display: block;
    }

    .checkBoxes label:hover {
      background-color: #4F615E;
      color: white;
    } */
  </style>
</head>

<body>
  <!-- hack to generate data, logs to console, or override -->
  <!-- idea is to copy paste from console to data.js -->
  <script src="make_data.js"></script>
  <!-- <script>
    let showRacks = true;
    function showCheckboxesRacks() {
      let checkboxes = document.getElementById("checkBoxesRacks");
      if (showRacks) {
        checkboxes.style.display = "block";
        showRacks = false;
      } else {
        checkboxes.style.display = "none";
        showRacks = true;
      }
    }
    function check_racks1000(el) {
      el.checked = !el.checked
      console.log(el);
      console.log("checkRacks1000");
    }
    function check_racks16x6(el) {
      el.checked = !el.checked
      console.log("checkRacks16X6");
    }
  </script> -->

  <div id="racksmenu">
    <button id="racks1000">1000</button>
    <button id="racks16x6">16x6</button>
    <div class="menuspace">|</div>
    <button id="hw_only">HW</button>
    <button id="sw_only">SW</button>
    <button id="iols_only">IOLS</button>
    <button id="kdi_only">KDI</button>
    <button id="qcs_only">QCS</button>
    <div class="menuspace">|</div>
    <button id="racks_count">Racks--</button>
    <button id="chassis_count">Chassis--</button>
    <button id="prune_slots">prune slots</button>
    <button id="prune_ssync">prune ssync</button>
    <div class="menuspace">|</div>
    <button id="lock_all">lock all</button>
    <button id="unlock_all">unlock all</button>
    <button id="save">save</button>
    <button id="restore">restore</button>
 
 
    <!-- <div class="menuspace">|</div>
    <div class="multipleSelection">
      <div class="selectBox" onclick="showCheckboxesRacks()">
        <select>
          <option>Racks</option>
        </select>
        <div class="overSelect"></div>
      </div>

      <div id="checkBoxesRacks" class="checkBoxes">
        <label for="check_racks1000">
          <input type="checkbox" id="check_racks1000" onclick="check_racks1000(this)"/>
          1000
        </label>
        <label for="check_racks16X6">
          <input type="checkbox" id="check_racks16X6"  onclick="check_racks1000(this)"/>
          16X6
        </label>
      </div>
    </div>
  </div> -->

  <div id="3d-graph"></div>

  <script type="importmap">{ "imports": { "three": "https://unpkg.com/three/build/three.module.js" }}</script>
  <script type="module">
    import { CSS2DRenderer, CSS2DObject } from '//unpkg.com/three/examples/jsm/renderers/CSS2DRenderer.js';

    const Graph = ForceGraph3D({
      extraRenderers: [new CSS2DRenderer()]
    })
      (document.getElementById('3d-graph'))
      // .jsonUrl('../datasets/racks.json')
      .graphData(data)
      .cooldownTime(8000)
      // .numDimensions(2) // flatten to a plane
      // .nodePositionUpdate((obj, coord, node) => {
      //   console.log(node);
      // })
      .linkDirectionalArrowLength(3.5)
      .linkDirectionalArrowRelPos(1)
      // .nodeAutoColorBy('group')
      .nodeColor(node => node_color(node.group)) // WARNING: only node, not text color
      //.nodeOpacity(0.2)
      // .linkAutoColorBy('value')
      .linkColor(node => link_color(node.value))
      //.linkOpacity(1.0)
      .linkWidth(2)
      .nodeThreeObject(node => {
        const nodeEl = document.createElement('div');
        nodeEl.textContent = node.id;
        // nodeEl.style.color = node.color;
        nodeEl.style.color = node_color(node.group);
        //nodeEl.style.opacity = 0.2;
        nodeEl.className = 'node-label';
        var text = "";
        if (node.names) {
          for (let i = 0; i < node.names.length; i++) {
            if (i > 0) text += "\n";
            text += node.names[i];
          }
        }
        nodeEl.innerText = text;
        return new CSS2DObject(nodeEl);
      })
      // .onNodeDragEnd(node => {
      //     node.fx = node.x;
      //     node.fy = node.y;
      //     node.fz = node.z;
      // })
      .onEngineStop(() => {
        console.log('onEngineStop');
      })
      .nodeThreeObjectExtend(true)
      ;


    const buttonRacks1000 = document.getElementById('racks1000');
    buttonRacks1000.addEventListener('click', function () {
      make_data_1000();
      Graph.graphData(data);
    }
    );
    const buttonRacks16x6 = document.getElementById('racks16x6');
    buttonRacks16x6.addEventListener('click', function () {
      make_data_16x6();
      Graph.graphData(data);
    }
    );
    const buttonRacksHwOnly = document.getElementById('hw_only');
    buttonRacksHwOnly.addEventListener('click', function () {
      make_data_hw_only();
      Graph.graphData(data);
    }
    );
    const buttonRacksSwOnly = document.getElementById('sw_only');
    buttonRacksSwOnly.addEventListener('click', function () {
      make_data_sw_only();
      Graph.graphData(data);
    }
    );
    const buttonRacksIolsOnly = document.getElementById('iols_only');
    buttonRacksIolsOnly.addEventListener('click', function () {
      make_data_iols_only();
      Graph.graphData(data);
    }
    );
    const buttonRacksKdiOnly = document.getElementById('kdi_only');
    buttonRacksKdiOnly.addEventListener('click', function () {
      make_data_kdi_only();
      Graph.graphData(data);
    }
    );
    const buttonRacksQcsOnly = document.getElementById('qcs_only');
    buttonRacksQcsOnly.addEventListener('click', function () {
      make_data_qcs_only();
      Graph.graphData(data);
    }
    );
    const buttonRacksRacksCountOnly = document.getElementById('racks_count');
    buttonRacksRacksCountOnly.addEventListener('click', function () {
      make_data_racks_count();
      Graph.graphData(data);
    }
    );
    const buttonRacksChassisCountOnly = document.getElementById('chassis_count');
    buttonRacksChassisCountOnly.addEventListener('click', function () {
      make_data_chassis_count();
      Graph.graphData(data);
    }
    );
    const buttonPruneSlots = document.getElementById('prune_slots');
    buttonPruneSlots.addEventListener('click', function () {
      prune_slots();
      Graph.graphData(data);
    }
    );
    const buttonPruneSSync = document.getElementById('prune_ssync');
    buttonPruneSSync.addEventListener('click', function () {
      prune_ssync();
      Graph.graphData(data);
    }
    );
    const buttonLockAll = document.getElementById('lock_all');
    buttonLockAll.addEventListener('click', function () {
      console.log('lock_all')
      for (let i=0; i<data.nodes.length; i++) {
        let node = data.nodes[i];
        node.fx = node.x;
        node.fy = node.y;
        node.fz = node.z;
      }
      Graph.graphData(data);
    }
    );
    const buttonUnlockAll = document.getElementById('unlock_all');
    buttonUnlockAll.addEventListener('click', function () {
      console.log('unlock_all')
      for (let i=0; i<data.nodes.length; i++) {
        let node = data.nodes[i];
        // BUG unlock a saved set expands more
        node.fx = null;
        node.fy = null;
        node.fz = null;
      }      
      Graph.graphData(data);
    }
    );
    const buttonSave = document.getElementById('save');
    buttonSave.addEventListener('click', function () {
      var nodes = Graph.graphData().nodes;
      var links = Graph.graphData().links;
      // get ids for localStorage (indexing ids should compress localStorage)
      // NOTE: if all ids are the index values, Graph still works but no human readable ids
      var allIds = [];
      for (let i=0; i<nodes.length; i++) {
        var node = nodes[i];
        allIds.push(node.id);
      }
      var setIds = new Set(allIds);
      var savedIds = [...setIds];
      // get nodes for localStorage (index the ids)
      var savedNodes = [];
      for (let i=0; i<nodes.length; i++) {
        var node = nodes[i];
        var id = savedIds.indexOf(node.id);
        savedNodes.push({
          "id": id,
          "group": node.group,
          "names": node.names,
          "fx": node.fx,
          "fy": node.fy,
          "fz": node.fz,
        })
      }
      // get links for localStorage (index the ids)
      var savedLinks = [];
      for (let i=0; i<links.length; i++) {
        var link = links[i];
        var source_id = savedIds.indexOf(link.source.id);
        var target_id = savedIds.indexOf(link.target.id);
        savedLinks.push({
          "source": source_id,
          "target": target_id,
          "value": link.value,
        })
      }
      try {
        // console.log(JSON.stringify(savedIds).length)
        // console.log(JSON.stringify(savedNodes).length)
        // console.log(JSON.stringify(savedLinks).length)
        localStorage.setItem("savedIds", JSON.stringify(savedIds));
        localStorage.setItem("savedNodes", JSON.stringify(savedNodes));
        localStorage.setItem("savedLinks", JSON.stringify(savedLinks));
      }
      catch(error) {
        console.log("savedNodes/savedLinks too big, ingnoring")
      }
      console.log('saved')
    }
    );
    const buttonRestore = document.getElementById('restore');
    buttonRestore.addEventListener('click', function () {
      // restore from localStorage if available
      const savedIds = JSON.parse(localStorage.getItem("savedIds"));
      const savedNodes = JSON.parse(localStorage.getItem("savedNodes"));
      const savedLinks = JSON.parse(localStorage.getItem("savedLinks"));
      if (savedIds && savedNodes && savedLinks) {
        if (savedIds.length > 0 && savedNodes.length > 0 && savedLinks.length > 0) {
          data.nodes = [];
          for (let i=0; i<savedNodes.length; i++) {
            var node = savedNodes[i];
            var id = savedIds[parseInt(node.id)];
            data.nodes.push({
              "id": id,
              "group": node.group,
              "names": node.names,
              "fx": node.fx,
              "fy": node.fy,
              "fz": node.fz,
            })
          }
          //data.links = savedLinks;
          data.links = [];
          for (let i=0; i<savedLinks.length; i++) {
            var link = savedLinks[i];
            var source_id = savedIds[parseInt(link.source)];
            var target_id = savedIds[parseInt(link.target)];
            data.links.push({
              "source": source_id,
              "target": target_id,
              "value": link.value,
            })
          }
        }
      }
      Graph.graphData(data);
      console.log('restore')
    }
    );

  </script>

</body>